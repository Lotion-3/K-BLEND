# K-BLEND

## Setup

Use requires linux terminal or ubuntu WSL.
WSL setup directions
1. Open command prompt run
```bash
wsl --install
```
2. Download ubuntu for WSL https://ubuntu.com/desktop/wsl
3. Open WSL

Virtual Environment setup  
```bash
git clone https://github.com/Lotion-3/K-BLEND
```
```bash
cd K-BLEND
```
```bash
sudo apt update
```
```bash
sudo apt install python3-venv
```
```bash
python3 -m venv Ensembleenv
```
```bash
source Ensembleenv/bin/activate
```
```bash
pip install -r req.txt
```

## Data Information  
All genomes compressed using 7z   
Extraction setup:  
```bash
sudo apt update
```
```bash
sudo apt install p7zip-full
```
This experiment utilized 11000 SARS-CoV-2 genomes from 11 strains. Alpha, Beta, Delta, Epsilon, Eta, Gamma, Iota, Lambda, Mu, Omicron, Zeta  
Sourced from NGDC: https://ngdc.cncb.ac.cn/  
Full data set is available in rawFastas folder  
combine_fasta.py file combined all 11000 into comb11000.fasta and generated key.fasta.     

The data set was used to create the 13 splits described in the paper which were generated by using split.py   
Available in fullPaperFastas folder. Warning extracts to 20GB data set.  
```bash
7z x fullPaperFastas.7z
```

Rest of tutorial uses sampleFastas data set containing only 2 splits.  
Available in sampleFastas folder. Extracts to 635MB.  
```bash
7z x sampleFastas.7z
```

The complete tables used in the paper are available in fullPaperTables along with code used to generate figures.  

## Ensemble Usage  
Pre usage setup  
1. Bash Permissions  
```bash
chmod +x Ensemble.sh
```
2. C++ Setup
```bash
sudo apt update
```
```bash
sudo apt install build-essential gdb
```
3. Jq setup
```bash
sudo apt-get install jq
```
4. Ramdisk setup
This example uses 8G of commited RAM, adjust to device specifications   
```bash
sudo mkdir -p /mnt/ramdisk
```
```bash
sudo mount -t tmpfs -o size=8G tmpfs /mnt/ramdisk
```
```bash
sudo chown $USER:$USER /mnt/ramdisk
```
```bash
echo always | sudo tee /sys/kernel/mm/transparent_hugepage/enabled
```
Run the Ensemble.sh file, this automated script trains 25 ensemble models and provides evaluation data.  
Execution arguments:  
```bash
./Ensemble.sh inputDirectory #cpuCores
```
The input directory expects two subdirectories, trainingFastas and testingFastas    
The script recognizes 2 naming systems for train test pairs  
1. Train: train%Train_11000_version# Test: test%test_11000_version#  
Ex. Train: train90_11000_5 Test: test10_11000_5  
Version numbers must match and percentages must add to 100  
2. Train: train_#sequences_version# Test: test_#sequences_version#   
Ex. Train: train_110_1 Test: test_10890_1  
Number of sequences must add to 11000 and version numbers must match  

The #cpuCores decides how many system cpuCores are dedicated to the execution.   
Train+Test pairs are processed one at a time. The 25 models are distributed amongst dedicated cores. One model per core.   
Default is half of system cores. Recommended maximum is the number of system cores -1.  

Usage with sampleFastas:  
```bash
./Ensemble.sh sampleFastas 2
```
Evaluation information is saved in the PIPELINE_RESULTS_HPC.csv file.  
Models are saved in saved_models/ directory.  

When finished clean ramdisk
```bash
sudo umount /mnt/ramdisk
```
```bash
sudo rm -r /mnt/ramdisk
```

## BLAST Benchmark usage
Download NCBI BLAST 2.16.0+ tool from: 
https://ftp.ncbi.nlm.nih.gov/blast/executables/blast+/LATEST/  
Place in K-BLEND directory  
Execution arguments:
```bash
python3 blastTesting.py inputDirectory
```
The input directory expects two subdirectories, trainingFastas and testingFastas    
The script recognizes 2 naming systems for train test pairs  
1. Train: train%Train_11000_version# Test: test%test_11000_version#  
Ex. Train: train90_11000_5 Test: test10_11000_5  
Version numbers must match and percentages must add to 100  
2. Train: train_#sequences_version# Test: test_#sequences_version#   
Ex. Train: train_110_1 Test: test_10890_1  
Number of sequences must add to 11000 and version numbers must match

Usage with sampleFastas:
```bash  
python3 blastTesting.py sampleFastas
```

Evaluation information is saved in blast_performance_metrics.csv  
Raw results in blastOutput folder  



